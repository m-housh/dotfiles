#!/usr/bin/env bash

set -e
set -o nounset
set -o pipefail

# A wrapper script to run swift-hpa in a docker container and
# mount the correct volumes, etc.
#
# Make sure to run 'hpa-init' first on this machine to setup
# dependencies, if you have not done so already.

# XDG vars.
XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}
XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}

# Docker vars.
HPA_DOCKER_IMAGE="git.housh.dev/michael/swift-hpa"
HPA_DOCKER_TAG=${HPA_DOCKER_TAG:-"latest"}

# Local vars.
HPA_DATA_DIR="$XDG_DATA_HOME/hpa"
HPA_CONFIG_DIR="$XDG_CONFIG_HOME/hpa"
CONSULTS_DIR=${CONSULTS_DIR:-$HOME/work/consults}
HPA_VAULT_SECRET_KEY="${HPA_VAULT_SECRET_KEY:-vault-pass}"

############################## MAIN ##############################

podman run --rm --interactive --tty \
  --volume "$HPA_DATA_DIR/template":/template \
  --volume "$HPA_DATA_DIR/playbook":/playbook \
  --volume "$HPA_CONFIG_DIR":/config/hpa \
  --volume "$CONSULTS_DIR":/consults \
  --secret "$HPA_VAULT_SECRET_KEY" \
  "$HPA_DOCKER_IMAGE:$HPA_DOCKER_TAG" "$@"
