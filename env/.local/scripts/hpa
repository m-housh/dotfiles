#!/usr/bin/env bash

set -e
set -o nounset
set -o pipefail

# A wrapper script to run swift-hpa in a docker container and
# mount the correct volumes, etc.
#
# To download templates, playbooks, setup secrets, generate shell completions, etc.
# you can call this script with 'init'.
#
# Otherwise it will run the hpa script inside of a docker container with any passed
# in arguments.

XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}
XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}

HPA_DOCKER_IMAGE="git.housh.dev/michael/swift-hpa"
HPA_DOCKER_TAG=${HPA_DOCKER_TAG:-"latest"}

HPA_DATA_DIR="$XDG_DATA_HOME/hpa"
HPA_CONFIG_DIR="$XDG_CONFIG_HOME/hpa"
CONSULTS_DIR=${CONSULTS_DIR:-$HOME/work/consults}

CONSULT_TEMPLATE_URL="ssh://git@git.housh.dev:2222/hhe/consult-template.git"
HPA_PLAYBOOK_URL="ssh://git@git.housh.dev:2222/michael/ansible-hpa-playbook.git"
HPA_VAULT_SECRET_KEY="${HPA_VAULT_SECRET_KEY:-vault-pass}"

echoerr() {
  echo -e "\e[31m[ERROR]:\e[0m $*"
}

generate-completion() {
  local output_dir output type
  type=${1:-"zsh"}
  output=${2:-$HOME/.zsh/completions/_hpa}
  output_dir=$(dirname "$output")

  [[ ! -d "$output_dir" ]] && mkdir -p "$output_dir"
  (
    podman run --rm -it "$HPA_DOCKER_IMAGE:$HPA_DOCKER_TAG" \
      --generate-completion-script "$type" |
      tr -d '\r'
  ) >"$output"
}

gnnerate-secret() {
  local secret=""
  secret="$(pass -c ansible/vault-pass)"
  printf "%s" "$secret" | podman secret create "$HPA_VAULT_SECRET_KEY" -
}

# Ensure the dependencies are installed / setup.
init() {
  generate-completion "$@"
  gnnerate-secret
  mkdir -p "$CONSULTS_DIR" &>/dev/null
  mkdir "$HPA_DATA_DIR" &>/dev/null
  [[ ! -d "$HPA_DATA_DIR/playbook" ]] && git clone "$HPA_PLAYBOOK_URL" "$HPA_DATA_DIR/playbook"
  [[ ! -d "$HPA_DATA_DIR/template" ]] && git clone "$CONSULT_TEMPLATE_URL" "$HPA_DATA_DIR/template"
}

run() {
  podman run --rm -it \
    --volume "$HPA_DATA_DIR/template":/template \
    --volume "$HPA_DATA_DIR/playbook":/playbook \
    --volume "$HPA_CONFIG_DIR":/config/hpa \
    --volume "$CONSULTS_DIR":/consults \
    --secret "$HPA_VAULT_SECRET_KEY" \
    "$HPA_DOCKER_IMAGE:$HPA_DOCKER_TAG" "$@"
}

# Helper to generate the project directory properly.
#
# This allows project to be created using `hpa create Customer`, and the project
# will be created with an actual directory named '25.11.05.Customer'.
#
# This also handles setting parent directory to the `/consults` directory inside
# the container, otherwise the project fails to get created.
#
# We also suppress all output and then generate the actual directory path on the local
# file system, so this command can be used like `cd -- $(hpa create Foo | tr -d '\r' | head -1)`.
create() {
  local project project_container_name dir_name
  project=${1:-""}

  [[ -z $project ]] && echoerr "Must supply a project name." && exit 1

  project_container_name="$(run create --quiet "/consults/$(date '+%Y.%m.%d').$project")"
  dir_name="$CONSULTS_DIR/$(basename "$project_container_name")"

  # Initialize git repo in the project and the initial commit.
  pushd "$(echo "$dir_name" | tr -d '\r' | head -1)" &>/dev/null || exit 1
  (
    git init
    git add .
    git commit --all --message="Initial commit"
  ) &>/dev/null
  popd &>/dev/null
  echo "$dir_name"
}

############################## MAIN ##############################

first_arg=${1:-""}

if [[ $first_arg == "init" ]]; then
  shift
  init "$@"
elif [[ $first_arg == "create" ]]; then
  shift
  echo "$(create "$@")"
else
  run "$@"
fi
